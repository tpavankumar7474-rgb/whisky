<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>World Map - Grafana Clustering</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { width:100%; height:100%; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// === Initialize map ===
const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// === Cluster group ===
const markers = L.markerClusterGroup();
map.addLayer(markers);

// === State tracking ===
let selectedMarker = null;
let selectedMarkerData = null;

// === Simple icon generator ===
function createIcon(color) {
  return new L.Icon({
    iconUrl: `https://chart.googleapis.com/chart?chst=d_map_pin_icon&chld=pin|${color}`,
    iconSize: [30, 50],
    iconAnchor: [15, 50],
    popupAnchor: [0, -45],
  });
}

// === Load Grafana data ===
function loadData(dataArray) {
  if (!dataArray || !dataArray.length) return;

  markers.clearLayers();
  selectedMarker = null;
  selectedMarkerData = null;

  dataArray.forEach((d) => {
    if (!d.lat || !d.long) return;

    const marker = L.marker([d.lat, d.long], { icon: createIcon('red') })
      .bindPopup(`<b>${d.state}</b><br>Count: ${d.count}<br>Lat: ${d.lat.toFixed(4)}<br>Lon: ${d.long.toFixed(4)}`);

    // === On marker click ===
    marker.on('click', function () {
      // Reset previously selected marker color
      if (selectedMarker) selectedMarker.setIcon(createIcon('red'));

      // Highlight this one
      marker.setIcon(createIcon('blue'));
      selectedMarker = marker;

      // Store clicked marker data
      selectedMarkerData = d;
      console.log('ğŸŸ¢ Marker clicked:', selectedMarkerData);

      // Send data back to Grafana (parent)
      window.parent.postMessage(
        {
          type: 'mapClick',
          data: selectedMarkerData,
        },
        '*'
      );
    });

    markers.addLayer(marker);
  });

  // Fit bounds to visible markers
  const group = new L.featureGroup(markers.getLayers());
  if (group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.2));
}

// === Listen for Grafana message ===
window.addEventListener('message', (event) => {
  const data = event.data;
  if (!data || !data.incidentData) return;
  console.log(`âœ… Received ${data.incidentData.length} records from Grafana`);
  loadData(data.incidentData);
});

console.log('ğŸ—ºï¸ Map initialized and waiting for Grafana data...');
</script>
</body>
</html>
