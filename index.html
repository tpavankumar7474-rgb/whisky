<!DOCTYPE html>
<html>
<head>
  <title>Interactive Map Iframe</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .leaflet-tooltip {
      background-color: rgba(0, 0, 0, 0.75);
      color: #fff;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // === Initialize map ===
    const map = L.map("map").setView([23.8859, 45.0792], 6); // Center on Saudi Arabia
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    const clusterGroup = L.markerClusterGroup();
    map.addLayer(clusterGroup);

    // === Marker icons ===
    const defaultIcon = L.icon({
      iconUrl: "https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png",
      shadowUrl: "https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const selectedIcon = L.icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    let selectedMarker = null; // Track selected marker
    let markerDataMap = new Map();

    console.log("Iframe map initialized, waiting for Grafana data...");

    // === Receive data from Grafana parent ===
    window.addEventListener("message", (event) => {
      const data = event.data;
      if (!data || !data.incidentData) {
        console.warn("Iframe: No incidentData found in message");
        return;
      }

      const arr = data.incidentData;
      console.log("Iframe: incidentData received:", arr);

      clusterGroup.clearLayers();
      markerDataMap.clear();
      selectedMarker = null;

      let bounds = [];

      arr.forEach((d) => {
        const { state, lat, long, count } = d;
        if (lat == null || long == null) return;

        const tooltip = `
          <strong>Location:</strong> ${state}<br/>
          <strong>Latitude:</strong> ${lat}<br/>
          <strong>Longitude:</strong> ${long}<br/>
          <strong>Count:</strong> ${count}
        `;

        const marker = L.marker([lat, long], { title: state, icon: defaultIcon });
        marker.bindTooltip(tooltip, { direction: "top", opacity: 0.9 });

        // === Marker click handler ===
        marker.on("click", () => {
          // If same marker clicked again → deselect
          if (selectedMarker === marker) {
            marker.setIcon(defaultIcon);
            selectedMarker = null;
            const payload = {
              type: "mapVariableReset",
              LOCATIONNAME: "All",
              Latitude: "All",
              Longitude: "All"
            };
            window.parent.postMessage(payload, "*");
            console.log("Marker deselected → Variables reset:", payload);
          } else {
            // Deselect previous marker
            if (selectedMarker) selectedMarker.setIcon(defaultIcon);

            // Highlight new marker
            marker.setIcon(selectedIcon);
            selectedMarker = marker;

            const payload = {
              type: "mapVariableUpdate",
              LOCATIONNAME: state,
              Latitude: lat,
              Longitude: long
            };
            window.parent.postMessage(payload, "*");
            console.log("Marker selected → Variables updated:", payload);
          }
        });

        clusterGroup.addLayer(marker);
        markerDataMap.set(state, { lat, long, count });
        bounds.push([lat, long]);
      });

      // Fit to bounds
      if (bounds.length > 0) {
        const b = L.latLngBounds(bounds);
        map.fitBounds(b, { padding: [40, 40] });
      }
    });

    console.log("Iframe map ready — waiting for incidentData from Grafana...");
  </script>
</body>
</html>
