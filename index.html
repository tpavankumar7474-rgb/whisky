<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>World Map - Grafana Clustering</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { width:100%; height:100%; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// === Initialize map ===
const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Marker cluster group
const markers = L.markerClusterGroup();
map.addLayer(markers);

// === Function to load Grafana data ===
function loadData(dataArray){
  if (!dataArray || !dataArray.length) return;

  markers.clearLayers();

  dataArray.forEach(d => {
    if (!d.lat || !d.long) return;

    const marker = L.marker([d.lat, d.long])
      .bindPopup(`<b>${d.state}</b><br>Count: ${d.count}<br>Lat: ${d.lat.toFixed(4)}<br>Lon: ${d.long.toFixed(4)}`);
    markers.addLayer(marker);
  });

  // Fit bounds to data
  const group = new L.featureGroup(markers.getLayers());
  if (group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.2));
}

// === Listen for Grafana message ===
window.addEventListener("message", (event) => {
  const data = event.data;
  if (!data || !data.incidentData) return;
  console.log(`âœ… Received ${data.incidentData.length} records from Grafana`);
  loadData(data.incidentData);
});
</script>
</body>
</html>
